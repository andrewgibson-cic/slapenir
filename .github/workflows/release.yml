# SLAPENIR Release Workflow
# Automated semantic versioning and releases using conventional commits

name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

env:
  RUST_VERSION: 1.93.0
  PYTHON_VERSION: 3.11

jobs:
  test:
    name: Run Tests Before Release
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        profile: minimal
        override: true
    
    - name: Run Rust tests
      working-directory: ./proxy
      run: |
        cargo test --lib --bins
        cargo test --test integration_test
        cargo test --test property_test
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Run Python tests
      run: |
        python3 agent/tests/test_agent.py
        python3 agent/tests/test_agent_advanced.py

  security:
    name: Security Scan Before Release
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        profile: minimal
    
    - name: Run cargo audit
      working-directory: ./proxy
      run: |
        cargo install cargo-audit --locked
        cargo audit --ignore RUSTSEC-2023-0071 --ignore RUSTSEC-2025-0134 || true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install pip-audit
      run: pip install pip-audit
    
    - name: Scan Python dependencies
      run: |
        pip-audit --desc || echo "No Python dependencies to audit"

  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
    
    - name: Install dependencies
      run: |
        npm install -g \
          semantic-release@23 \
          @semantic-release/changelog@6 \
          @semantic-release/git@10 \
          @semantic-release/github@10 \
          @semantic-release/exec@6 \
          conventional-changelog-conventionalcommits@7
    
    - name: Create semantic-release config
      run: |
        cat > .releaserc.json << 'EOF'
        {
          "branches": ["main"],
          "plugins": [
            [
              "@semantic-release/commit-analyzer",
              {
                "preset": "conventionalcommits",
                "releaseRules": [
                  { "type": "feat", "release": "minor" },
                  { "type": "fix", "release": "patch" },
                  { "type": "perf", "release": "patch" },
                  { "type": "revert", "release": "patch" },
                  { "type": "docs", "release": false },
                  { "type": "style", "release": false },
                  { "type": "refactor", "release": "patch" },
                  { "type": "test", "release": false },
                  { "type": "build", "release": false },
                  { "type": "ci", "release": false },
                  { "type": "chore", "release": false }
                ]
              }
            ],
            [
              "@semantic-release/release-notes-generator",
              {
                "preset": "conventionalcommits",
                "presetConfig": {
                  "types": [
                    { "type": "feat", "section": "Features" },
                    { "type": "fix", "section": "Bug Fixes" },
                    { "type": "perf", "section": "Performance Improvements" },
                    { "type": "revert", "section": "Reverts" },
                    { "type": "refactor", "section": "Code Refactoring" },
                    { "type": "docs", "section": "Documentation", "hidden": false },
                    { "type": "style", "section": "Styles", "hidden": true },
                    { "type": "chore", "section": "Miscellaneous", "hidden": true },
                    { "type": "test", "section": "Tests", "hidden": true },
                    { "type": "build", "section": "Build System", "hidden": true },
                    { "type": "ci", "section": "CI/CD", "hidden": true }
                  ]
                }
              }
            ],
            [
              "@semantic-release/changelog",
              {
                "changelogFile": "CHANGELOG.md"
              }
            ],
            [
              "@semantic-release/exec",
              {
                "prepareCmd": "bash scripts/update-version.sh ${nextRelease.version}"
              }
            ],
            [
              "@semantic-release/github",
              {
                "assets": [
                  {
                    "path": "VERSION",
                    "label": "Version file"
                  }
                ]
              }
            ],
            [
              "@semantic-release/git",
              {
                "assets": ["CHANGELOG.md", "VERSION", "proxy/Cargo.toml"],
                "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
              }
            ]
          ]
        }
        EOF
    
    - name: Run semantic-release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: npx semantic-release
    
    - name: Get version
      id: version
      run: |
        if [ -f VERSION ]; then
          echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT
          echo "Released version: $(cat VERSION)"
        else
          echo "No new version released"
          echo "version=none" >> $GITHUB_OUTPUT
        fi

  docker:
    name: Build and Tag Docker Images
    runs-on: ubuntu-latest
    needs: release
    if: needs.release.result == 'success'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Get version
      id: version
      run: |
        if [ -f VERSION ]; then
          echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT
        else
          echo "version=latest" >> $GITHUB_OUTPUT
        fi
    
    - name: Build proxy image
      run: |
        docker build -t slapenir-proxy:${{ steps.version.outputs.version }} ./proxy
        docker tag slapenir-proxy:${{ steps.version.outputs.version }} slapenir-proxy:latest
    
    - name: Build agent image
      run: |
        docker build -t slapenir-agent:${{ steps.version.outputs.version }} ./agent
        docker tag slapenir-agent:${{ steps.version.outputs.version }} slapenir-agent:latest
    
    - name: Image info
      run: |
        echo "Built Docker images:"
        echo "  - slapenir-proxy:${{ steps.version.outputs.version }}"
        echo "  - slapenir-agent:${{ steps.version.outputs.version }}"
        docker images | grep slapenir

  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [test, security, release, docker]
    if: always()
    
    steps:
    - name: Check results
      run: |
        echo "üéâ Release Pipeline Summary"
        echo "=========================="
        echo "Tests: ${{ needs.test.result }}"
        echo "Security: ${{ needs.security.result }}"
        echo "Release: ${{ needs.release.result }}"
        echo "Docker: ${{ needs.docker.result }}"
        echo ""
        if [ "${{ needs.release.result }}" == "success" ]; then
          echo "‚úÖ New version released successfully!"
        else
          echo "‚ÑπÔ∏è No new version released (no conventional commits found)"
        fi