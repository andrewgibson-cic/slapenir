# SLAPENIR Test Workflow
# Runs comprehensive test suite on push and PR

name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  RUST_VERSION: 1.93.0
  PYTHON_VERSION: 3.11

jobs:
  proxy-tests:
    name: Proxy Tests (Rust)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        profile: minimal
        override: true
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v3
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v3
      with:
        path: proxy/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      working-directory: ./proxy
      run: cargo fmt -- --check
    
    - name: Run clippy
      working-directory: ./proxy
      run: cargo clippy -- -D warnings
      continue-on-error: true
      id: clippy
    
    - name: Run unit tests
      working-directory: ./proxy
      run: cargo test --lib --bins
      id: unit_tests
    
    - name: Run integration tests
      working-directory: ./proxy
      run: cargo test --test integration_test
      id: integration_tests
    
    - name: Run property-based tests
      working-directory: ./proxy
      run: cargo test --test property_test
      id: property_tests
    
    - name: Generate test summary
      if: always()
      run: |
        echo "## ðŸ¦€ Proxy (Rust) Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Clippy | ${{ steps.clippy.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | ${{ steps.unit_tests.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | ${{ steps.integration_tests.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Property Tests | ${{ steps.property_tests.outcome }} |" >> $GITHUB_STEP_SUMMARY

  python-lint:
    name: Python Linting & Formatting
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install ruff black
    
    - name: Run ruff linter
      run: |
        ruff check agent/scripts/ --output-format=github
      continue-on-error: true
    
    - name: Check formatting with black
      run: |
        black --check agent/scripts/
      continue-on-error: true
    
    - name: Generate lint report
      if: always()
      run: |
        echo "## ðŸ Python Code Quality" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Linting (ruff)" >> $GITHUB_STEP_SUMMARY
        ruff check agent/scripts/ --statistics || echo "âš ï¸ Linting issues found" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Formatting (black)" >> $GITHUB_STEP_SUMMARY
        black --check agent/scripts/ && echo "âœ… Code is properly formatted" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Formatting issues found" >> $GITHUB_STEP_SUMMARY

  agent-tests:
    name: Agent Tests (Python)
    runs-on: ubuntu-latest
    needs: [python-lint]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
    
    - name: Run basic tests
      run: python3 agent/tests/test_agent.py
      continue-on-error: true
      id: basic_tests
    
    - name: Run advanced tests
      run: python3 agent/tests/test_agent_advanced.py
      continue-on-error: true
      id: advanced_tests
    
    - name: Run security credential tests
      run: |
        # Run with pytest for better reporting
        pytest agent/tests/test_security_credentials.py -v --tb=short --no-header 2>&1 | tee test_results.txt
      continue-on-error: true
      id: security_tests
    
    - name: Generate test summary
      if: always()
      run: |
        echo "## ðŸ§ª Agent Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Extract test results if pytest was used
        if [ -f test_results.txt ]; then
          # Count passed/failed/skipped
          PASSED=$(grep -oP '\d+ passed' test_results.txt | grep -oP '\d+' || echo "0")
          FAILED=$(grep -oP '\d+ failed' test_results.txt | grep -oP '\d+' || echo "0")
          SKIPPED=$(grep -oP '\d+ skipped' test_results.txt | grep -oP '\d+' || echo "0")
          
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸ Skipped: $SKIPPED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract failed test names
          if [ "$FAILED" != "0" ]; then
            echo "### âŒ Failed Tests" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep "FAILED" test_results.txt | head -20 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ“ Note" >> $GITHUB_STEP_SUMMARY
            echo "These tests expect the agent to run in a containerized environment." >> $GITHUB_STEP_SUMMARY
            echo "Some failures in CI are expected when tests check for container-specific files/paths." >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Test Status" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Basic Tests | ${{ steps.basic_tests.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Advanced Tests | ${{ steps.advanced_tests.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Tests | ${{ steps.security_tests.outcome }} |" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: agent-test-results
        path: test_results.txt
    
    - name: Generate coverage report
      run: |
        pytest agent/tests/ --cov=agent/scripts --cov-report=xml || true
      continue-on-error: true
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: agent
        name: agent-coverage
      continue-on-error: true

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [proxy-tests, agent-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create required env files
      run: |
        # Create .env.proxy from example (CI doesnt need real secrets)
        if [ ! -f .env.proxy ]; then
          cp .env.proxy.example .env.proxy || echo "# CI dummy env" > .env.proxy
        fi
    
    - name: Validate docker-compose
      run: docker compose config
    
    - name: Build services
      run: docker compose build
      timeout-minutes: 10
    
    - name: Start services
      run: docker compose up -d
    
    - name: Wait for services
      run: |
        echo "Waiting for services to be ready..."
        sleep 10
        docker compose ps
    
    - name: Test proxy health
      run: |
        curl -f http://localhost:3000/health || exit 1
      continue-on-error: true
      id: proxy_health
    
    - name: Generate integration summary
      if: always()
      run: |
        echo "## ðŸ³ Integration Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Proxy Health | ${{ steps.proxy_health.outcome }} |" >> $GITHUB_STEP_SUMMARY
    
    - name: Check service logs
      if: always()
      run: |
        echo "### Proxy Logs" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        docker compose logs proxy | tail -50 >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Agent Logs" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        docker compose logs agent | tail -50 >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Stop services
      if: always()
      run: docker compose down

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        profile: minimal
    
    - name: Run cargo audit
      working-directory: ./proxy
      run: |
        cargo install cargo-audit
        cargo audit
      continue-on-error: true
      id: cargo_audit
    
    - name: Run cargo deny
      working-directory: ./proxy
      run: |
        cargo install cargo-deny
        cargo deny check
      continue-on-error: true
      id: cargo_deny
    
    - name: Generate security summary
      if: always()
      run: |
        echo "## ðŸ”’ Security Audit Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| cargo-audit | ${{ steps.cargo_audit.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| cargo-deny | ${{ steps.cargo_deny.outcome }} |" >> $GITHUB_STEP_SUMMARY

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [proxy-tests, agent-tests, integration-tests, security-audit]
    if: always()
    
    steps:
    - name: Generate overall summary
      run: |
        echo "# ðŸ“Š Complete Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Job Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Proxy Tests (Rust) | ${{ needs.proxy-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Agent Tests (Python) | ${{ needs.agent-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Audit | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*View detailed results in individual job summaries above*" >> $GITHUB_STEP_SUMMARY