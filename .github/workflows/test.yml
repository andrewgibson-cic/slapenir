# SLAPENIR Test Workflow
# Runs comprehensive test suite on push and PR

name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  RUST_VERSION: 1.93.0
  PYTHON_VERSION: 3.11

jobs:
  proxy-tests:
    name: Proxy Tests (Rust)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        profile: minimal
        override: true
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v3
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v3
      with:
        path: proxy/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      working-directory: ./proxy
      run: cargo fmt -- --check
    
    - name: Run clippy
      working-directory: ./proxy
      run: cargo clippy -- -D warnings
    
    - name: Run unit tests
      working-directory: ./proxy
      run: cargo test --lib --bins
    
    - name: Run integration tests
      working-directory: ./proxy
      run: cargo test --test integration_test
    
    - name: Run property-based tests
      working-directory: ./proxy
      run: cargo test --test property_test
    
    - name: Generate coverage report
      working-directory: ./proxy
      run: |
        cargo install cargo-tarpaulin
        cargo tarpaulin --out Xml --output-dir ../coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/cobertura.xml
        flags: proxy
        name: proxy-coverage

  python-lint:
    name: Python Linting & Formatting
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install ruff black
    
    - name: Run ruff linter
      run: |
        ruff check agent/scripts/ --output-format=github
      continue-on-error: true
    
    - name: Check formatting with black
      run: |
        black --check agent/scripts/
      continue-on-error: true
    
    - name: Generate lint report
      if: always()
      run: |
        echo "## ðŸ Python Code Quality" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Linting (ruff)" >> $GITHUB_STEP_SUMMARY
        ruff check agent/scripts/ --statistics || echo "âš ï¸ Linting issues found" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Formatting (black)" >> $GITHUB_STEP_SUMMARY
        black --check agent/scripts/ && echo "âœ… Code is properly formatted" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Formatting issues found" >> $GITHUB_STEP_SUMMARY

  agent-tests:
    name: Agent Tests (Python)
    runs-on: ubuntu-latest
    needs: [python-lint]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
    
    - name: Run basic tests
      run: python3 agent/tests/test_agent.py
    
    - name: Run advanced tests
      run: python3 agent/tests/test_agent_advanced.py
    
    - name: Generate coverage report
      run: |
        pytest agent/tests/ --cov=agent/scripts --cov-report=xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: agent
        name: agent-coverage

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [proxy-tests, agent-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Validate docker-compose
      run: docker compose config
    
    - name: Build services
      run: docker compose build
    
    - name: Start services
      run: docker compose up -d
    
    - name: Wait for services
      run: |
        sleep 10
        docker compose ps
    
    - name: Test proxy health
      run: |
        curl -f http://localhost:3000/health || exit 1
    
    - name: Check service logs
      if: always()
      run: |
        docker compose logs proxy
        docker compose logs agent
    
    - name: Stop services
      if: always()
      run: docker compose down

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        profile: minimal
    
    - name: Run cargo audit
      working-directory: ./proxy
      run: |
        cargo install cargo-audit
        cargo audit
    
    - name: Run cargo deny
      working-directory: ./proxy
      run: |
        cargo install cargo-deny
        cargo deny check

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [proxy-tests, agent-tests, integration-tests, security-audit]
    if: always()
    
    steps:
    - name: Check test results
      run: |
        echo "âœ… All tests completed"
        echo "Proxy tests: ${{ needs.proxy-tests.result }}"
        echo "Agent tests: ${{ needs.agent-tests.result }}"
        echo "Integration tests: ${{ needs.integration-tests.result }}"
        echo "Security audit: ${{ needs.security-audit.result }}"