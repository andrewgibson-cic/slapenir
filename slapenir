#!/bin/bash
# SLAPENIR Control Script - One-line management
# Usage: ./slapenir [start|stop|restart|status|logs|clean]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
info() { echo -e "${BLUE}â„¹${NC} $1"; }
success() { echo -e "${GREEN}âœ“${NC} $1"; }
warning() { echo -e "${YELLOW}âš ${NC} $1"; }
error() { echo -e "${RED}âœ—${NC} $1"; }

check_env() {
    if [ ! -f ".env" ]; then
        warning ".env file not found!"
        info "Creating from template..."
        if [ -f ".env.example" ]; then
            cp .env.example .env
            warning "Please edit .env with your API keys before starting"
            echo ""
            echo "  nano .env  # or use your favorite editor"
            echo ""
            exit 1
        else
            error ".env.example not found!"
            exit 1
        fi
    fi
}

check_certs() {
    if ! docker volume ls | grep -q "slapenir-proxy-certs"; then
        info "Certificates not found. Will be generated on first docker-compose up"
    fi
}

start() {
    echo "=========================================="
    echo "  ðŸš€ Starting SLAPENIR"
    echo "=========================================="
    echo ""
    
    check_env
    check_certs
    
    info "Starting services..."
    docker-compose up -d --build
    
    info "Waiting for services (8s)..."
    sleep 8
    
    echo ""
    status
}

stop() {
    echo "=========================================="
    echo "  ðŸ›‘ Stopping SLAPENIR"
    echo "=========================================="
    echo ""
    
    info "Stopping services..."
    docker-compose down
    
    success "All services stopped"
}

restart() {
    echo "=========================================="
    echo "  ðŸ”„ Restarting SLAPENIR"
    echo "=========================================="
    echo ""
    
    info "Stopping services..."
    docker-compose down
    
    echo ""
    start
}

status() {
    echo "=========================================="
    echo "  ðŸ“Š SLAPENIR Status"
    echo "=========================================="
    echo ""
    
    # Check if services are running
    if ! docker-compose ps | grep -q "Up"; then
        warning "Services are not running"
        echo ""
        info "Start with: ./slapenir start"
        exit 0
    fi
    
    # Check individual services
    info "Service Health:"
    
    # Proxy
    if curl -s http://localhost:3000/health > /dev/null 2>&1; then
        success "Proxy (http://localhost:3000)"
    else
        error "Proxy (not responding)"
    fi
    
    # Step CA
    if docker-compose ps | grep "slapenir-ca" | grep -q "Up"; then
        success "Step CA (https://localhost:9000)"
    else
        error "Step CA (not running)"
    fi
    
    # Agent
    if docker-compose ps | grep "slapenir-agent" | grep -q "Up"; then
        success "Agent (running)"
    else
        error "Agent (not running)"
    fi
    
    # Prometheus
    if curl -s http://localhost:9090/-/healthy > /dev/null 2>&1; then
        success "Prometheus (http://localhost:9090)"
    else
        warning "Prometheus (not responding)"
    fi
    
    # Grafana
    if curl -s http://localhost:3001/api/health > /dev/null 2>&1; then
        success "Grafana (http://localhost:3001)"
    else
        warning "Grafana (not responding)"
    fi
    
    echo ""
    info "Access Points:"
    echo "  â€¢ Proxy:      http://localhost:3000"
    echo "  â€¢ Health:     http://localhost:3000/health"
    echo "  â€¢ Metrics:    http://localhost:3000/metrics"
    echo "  â€¢ Prometheus: http://localhost:9090"
    echo "  â€¢ Grafana:    http://localhost:3001 (admin/admin)"
}

logs() {
    service="${1:-}"
    
    if [ -z "$service" ]; then
        info "Following all logs (Ctrl+C to exit)..."
        docker-compose logs -f
    else
        info "Following $service logs (Ctrl+C to exit)..."
        docker-compose logs -f "$service"
    fi
}

shell() {
    service="${1:-agent}"
    
    echo "=========================================="
    echo "  ðŸš Opening Shell: $service"
    echo "=========================================="
    echo ""
    
    if ! docker-compose ps | grep "slapenir-$service" | grep -q "Up"; then
        error "$service container is not running"
        info "Start services with: ./slapenir start"
        exit 1
    fi
    
    info "Opening interactive shell in $service container..."
    echo ""
    
    if [ "$service" = "agent" ]; then
        docker-compose exec agent /bin/sh
    elif [ "$service" = "proxy" ]; then
        docker-compose exec proxy /bin/sh
    else
        error "Unknown service: $service"
        info "Available services: agent, proxy"
        exit 1
    fi
}

clean() {
    echo "=========================================="
    echo "  ðŸ§¹ Cleaning SLAPENIR"
    echo "=========================================="
    echo ""
    
    warning "This will remove all containers, volumes, and certificates!"
    read -p "Are you sure? (yes/no): " confirm
    
    if [ "$confirm" != "yes" ]; then
        info "Cancelled"
        exit 0
    fi
    
    info "Stopping services..."
    docker-compose down -v 2>/dev/null || true
    
    info "Removing volumes..."
    docker volume rm -f slapenir-ca-config slapenir-ca-certs slapenir-proxy-certs slapenir-agent-certs slapenir-agent-workspace slapenir-prometheus-data slapenir-grafana-data 2>/dev/null || true
    
    success "Cleanup complete"
    info "Run './slapenir start' to initialize from scratch"
}

usage() {
    echo "SLAPENIR Control Script"
    echo ""
    echo "Usage: ./slapenir <command>"
    echo ""
    echo "Commands:"
    echo "  start    - Start all services (generates certs if needed)"
    echo "  stop     - Stop all services"
    echo "  restart  - Restart all services"
    echo "  status   - Show service status and health"
    echo "  logs     - Follow logs (all services or specific: ./slapenir logs proxy)"
    echo "  shell    - Open shell in container (default: agent)"
    echo "  clean    - Remove all containers, volumes, and certificates"
    echo ""
    echo "Examples:"
    echo "  ./slapenir start          # Start everything"
    echo "  ./slapenir status         # Check health"
    echo "  ./slapenir logs proxy     # View proxy logs"
    echo "  ./slapenir shell          # Shell into agent"
    echo "  ./slapenir shell proxy    # Shell into proxy"
    echo "  ./slapenir restart        # Restart all services"
    echo "  ./slapenir stop           # Stop everything"
    echo ""
}

# Main command handler
case "${1:-}" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    status)
        status
        ;;
    logs)
        logs "${2:-}"
        ;;
    shell)
        shell "${2:-}"
        ;;
    clean)
        clean
        ;;
    *)
        usage
        exit 1
        ;;
esac
